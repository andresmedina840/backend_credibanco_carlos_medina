name: Deploy Backend Credibanco

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Clonar el repositorio en EC2 y actualizar cÃ³digo"
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ“‚ Ingresando a la carpeta del proyecto en EC2..."
            cd /home/ubuntu/app || { echo "âŒ ERROR: No se encontrÃ³ el directorio"; exit 1; }
            
            echo "ğŸ”„ Actualizando el cÃ³digo desde GitHub..."
            git reset --hard HEAD
            git pull origin main || { echo "âŒ ERROR: No se pudo hacer git pull"; exit 1; }

            echo "ğŸ“¦ Bajando contenedores anteriores..."
            docker-compose down

            echo "ğŸš€ Construyendo y levantando contenedores..."
            docker-compose up -d --build
            docker ps
