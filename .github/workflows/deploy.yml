name: Deploy Backend Credibanco

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: "📥 Clonar el repositorio en EC2 y actualizar código"
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "📂 Ingresando a la carpeta del proyecto en EC2..."
            cd /home/ubuntu/app || { echo "❌ ERROR: No se encontró el directorio"; exit 1; }
            
            echo "🔄 Actualizando el código desde GitHub..."
            git reset --hard HEAD
            git pull origin main || { echo "❌ ERROR: No se pudo hacer git pull"; exit 1; }

            echo "📦 Bajando contenedores anteriores..."
            docker-compose down

            echo "🚀 Construyendo y levantando contenedores..."
            docker-compose up -d --build
            docker ps
