name: Deploy Backend Credibanco

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout del código"
        uses: actions/checkout@v4

      - name: "Configurar JDK 21"
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: "Compilar Backend con Maven (Perfil Producción)"
        run: mvn clean package -Pproduccion -DskipTests

      - name: "Verificar que el JAR se haya generado"
        run: |
          echo "Verificando archivos generados por Maven..."
          ls -lah target/ || { echo "❌ ERROR: No se generó el JAR"; exit 1; }

      - name: "Iniciar Docker"
        run: sudo systemctl start docker

      - name: "Construir imagen Docker con perfil de producción"
        run: |
          docker build --build-arg SPRING_PROFILES_ACTIVE=produccion -t backend-credibanco .
          docker images | grep backend-credibanco || { 
            echo "❌ ERROR: No se generó la imagen Docker"; 
            exit 1; 
          }

      - name: "Guardar imagen Docker como tar.gz"
        run: |
          docker save -o image.tar.gz backend-credibanco
          echo "Verificando que el archivo image.tar.gz existe..."
          ls -lah image.tar.gz || { echo "❌ ERROR: No se generó image.tar.gz"; exit 1; }

      - name: "Ajustar permisos antes de la transferencia"
        run: |
          echo "Ajustando permisos..."
          chmod 644 target/credibanco.jar docker-compose.yml .env image.tar.gz
          ls -lah target/credibanco.jar docker-compose.yml .env image.tar.gz

      - name: "DEPURACIÓN: Imprimir ruta de trabajo"
        run: |
          echo "Directorio actual:"
          pwd
          echo "Listando todos los archivos disponibles:"
          find . -type f

      - name: "Transferir archivos al servidor"
        uses: appleboy/scp-action@v0.1.3
        with:
          debug: true
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "target/credibanco.jar docker-compose.yml .env image.tar.gz"
          target: "/home/ubuntu/app"
          overwrite: true
          timeout: 30s
          command_timeout: 10m
          use_insecure_cipher: false

      - name: "Verificar archivos en el servidor después de la transferencia"
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Archivos en el servidor después de scp-action:"
            ls -lah /home/ubuntu/app || { echo "❌ ERROR: No se transfirieron los archivos"; exit 1; }

            export SPRING_PROFILES_ACTIVE=produccion

            docker load -i /home/ubuntu/app/image.tar.gz
            docker-compose down
            docker-compose up -d --force-recreate
            docker ps
