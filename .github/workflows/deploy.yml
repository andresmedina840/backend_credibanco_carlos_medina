name: Deploy Backend Credibanco

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸš€ Compilar Backend con Maven (Perfil ProducciÃ³n)
        run: mvn clean package -Pproduccion -DskipTests

      - name: ğŸ› ï¸ Verificar que el JAR se haya generado
        run: |
          ls -lah target/credibanco.jar || { 
            echo "âŒ ERROR: No se generÃ³ el JAR"; 
            exit 1; 
          }

      - name: ğŸ³ Iniciar Docker
        run: sudo systemctl start docker

      - name: ğŸ—ï¸ Construir imagen Docker con perfil de producciÃ³n
        run: |
          docker build --build-arg SPRING_PROFILES_ACTIVE=produccion -t backend-credibanco .
          docker images | grep backend-credibanco || { 
            echo "âŒ ERROR: No se generÃ³ la imagen Docker"; 
            exit 1; 
          }

      - name: ğŸ“¦ Guardar imagen Docker como tar.gz
        run: |
          docker save -o image.tar.gz backend-credibanco
          ls -lah image.tar.gz || { 
            echo "âŒ ERROR: No se generÃ³ image.tar.gz"; 
            exit 1; 
          }

      - name: ğŸ“‚ Verificar archivos antes de la transferencia
        run: ls -lah target/credibanco.jar docker-compose.yml .env image.tar.gz

      - name: ğŸš€ Transferir archivos al servidor
        uses: appleboy/scp-action@v0.1.3
        with:
          debug: true
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            target/credibanco.jar
            docker-compose.yml
            .env
            image.tar.gz
          target: "/home/ubuntu/app"
          overwrite: true

      - name: ğŸ–¥ï¸ Conectar al servidor y desplegar con perfil de producciÃ³n
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app
            ls -lah  # Verificar archivos en el servidor
            
            # Establecer el perfil de producciÃ³n en el entorno
            export SPRING_PROFILES_ACTIVE=produccion
            
            docker load -i image.tar.gz
            docker-compose down
            docker-compose up -d --force-recreate
            docker ps