name: ğŸš€ Deploy to EC2 - Full Solution

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      EC2_IP: ${{ secrets.AWS_EC2_IP }}
      REPO_URL: https://github.com/andresmedina840/backend_credibanco_carlos_medina.git
      SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    steps:
      - name: ğŸ”‘ Crear y configurar clave SSH
        run: |
          echo "ğŸ—ï¸ Preparando clave PEM..."
          echo "$SSH_KEY" > clave.pem
          chmod 600 clave.pem
          mkdir -p ~/.ssh
          ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts

      - name: ğŸš€ Ejecutar despliegue completo
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ubuntu
          script: |
            # Crear estructura de directorios
            sudo mkdir -p /home/ubuntu/app
            sudo chown -R ubuntu:ubuntu /home/ubuntu/app

            # Clonar/Actualizar repositorio
            cd /home/ubuntu/app
            if [ ! -d .git ]; then
              git clone $REPO_URL .
            fi
            
            # Forzar actualizaciÃ³n del cÃ³digo
            git fetch --all
            git reset --hard origin/main
            git clean -fd -x
            
            # Reconstruir contenedores
            docker-compose down -v --remove-orphans
            docker-compose build --no-cache
            docker-compose up -d
            
            # Verificaciones finales
            echo "ğŸ” Estado de los contenedores:"
            docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo "ğŸ“œ Ãšltimos logs del backend:"
            docker-compose logs --tail=50 backend
          debug: true
          timeout: 10m

      - name: ğŸŒ Probar endpoint de la API
        run: |
          echo "ğŸ©º Realizando health check..."
          curl -sSf http://$EC2_IP:8080/api/health || echo "âš ï¸ Health check fallÃ³"
        timeout-minutes: 2